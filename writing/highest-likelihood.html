<!DOCTYPE html>
<html lang="en" id="html">

<head>
    <meta charset="utf-8">
    <title>Suhas Kotha</title>
    <!-- <script src="jquery-3.6.3.min.js"></script> -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true
          }
        });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"></script>
    </script>
    <meta name="description" content="Highest Likelihood Decoding">
    <meta name="author" content="Suhas Kotha">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Quicksand' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="../css/style.css?v=<?php echo rand(); ?>">
    <link rel="icon" type="image/png" href="../images/dragon_logo.png">
    <style id="autogen"></style>
</head>

<body style="max-width: 100%; margin: 0 auto;">
    <p><a href=../index.html>Home</a></p>
    <div class="blog-post">
        <br>

        <h1>Highest Likelihood Decoding</h1>

        <br>
        <p style="text-align: center;">5/21/2024</p>
        <br>

        <p>Code available <a href="https://github.com/kothasuhas/highest_likelihood">here</a>. Special thanks to help from <a href="https://www.linkedin.com/in/amanda--li">Amanda Li</a> and discussion with <a href="https://sprin.xyz/">Jacob Springer</a> and <a href="https://vaishnavh.github.io/home/index.html">Vaishnavh Nagarajan</a>.</p>

        <h3>Introduction</h3>

        <p> A causal language model takes in a sequence of tokens and produces a probability distribution over the next token, which is then sampled with some temperature. Lowering this temperature approaches greedily selecting the next token with the highest probability (illustrated in Figure 1). However, greedy decoding does not necessarily sample the sequence of tokens the model assigns the highest likelihood. This may be important for difficult tasks where quality is of the utmost importance. On the other hand, the highest likelihood generations may be unnatural/pathological. This motivates the following question: Is the highest likelihood string better than the greedy string? </p>

        <figure>
            <img src="../images/highest-likelihood/greedy.png" style="max-width: 70%; height: auto;">
            <p>
            <figcaption>Figure 1: Example of greedy decoding for an arithmetic prompt. At each step, we use the model to select the next token instead of exploring the entire space of strings.</figcaption>
            </p>
        </figure>

        <h3>Highest Likelihood Decoding Algorithm</h3>

        <p>We would like to find the $k$ token sequence from a vocab size $V$ that achieves the highest likelihood under the model. The computational prohibitive brute force would be to try all $V^k$ possible completions. To get around this, we implement a depth-first search with two heuristics that significantly lower the runtime.</p>

        <br>

        <p> Our first heuristic is maintaining the best full-length sequence found so far. We note that the likelihood of a string can only decrease if you add more characters to it. Suppose we encounter an intermediate node of the tree, representing an uncompleted sequence of $< k$ tokens, which already has lower likelihood than our current best length $k$ sequence. Since the likelihood can only go down, none of the children are candidates for the highest likelihood sequence. Therefore, we can stop traversing down this node's children and move on to exploring other nodes. </p>

        <br>

        <p> Our second heuristic is re-ordering the children of any intermediate node by the likelihood of each child. Without the first heuristic, this re-ordering does not change the runtime of the algorithm at all. However, this heuristic will probably help us run into the highest likelihood sequence earlier. This complements the first heuristic quite nicely--since we run into better sequences earlier, we can prune more aggressively.</p>
            
        <figure>
            <img src="../images/highest-likelihood/highest-likelihood.png" style="max-width: 70%; height: auto;">
            <p>
            <figcaption>Figure 2: Highest likelihood decoding. We maintain a best likelihood counter for pruning during our DFS, while greedily re-ordering children to improve this counter.</figcaption>
            </p>
        </figure>

        <h3>Results</h3>

        <p>Due to computational limitations, we test with the relatively smaller open-source models of Pythia-70m, Pythia-160m, and Pythia-410m <cite><a href="https://arxiv.org/abs/2304.01373">(Biderman et al, 2023)</a></cite>. We test decoding from the model starting with the empty sequence (only the BOS token). To constrain the search space, we only use a 188 token subset sourced from common English words and sentences. We track the best completion for these models from lengths 1 to 8 in Table 1. </p>

        <br>

        <table border="1" style="margin: auto;">
            <caption><p>Table 1: Highest likelihood and greedy completions for lengths 1 to 8 from Pythia models.</p></caption>
            <tr>
                <th></th>
                <th><p>Pythia-70m</p></th>
                <th><p>Pythia-160m</p></th>
                <th><p>Pythia-410m</p></th>
            </tr>
            <tr>
                <td><p>1</p></td>
                <td><p>The</p></td>
                <td><p>The</p></td>
                <td><p>The</p></td>
            </tr>
            <tr>
                <td><p>2</p></td>
                <td><p>It is</p></td>
                <td><p>We are</p></td>
                <td><p>It is</p></td>
            </tr>
            <tr>
                <td><p>3</p></td>
                <td><p>I have a</p></td>
                <td><p>It is a</p></td>
                <td><p>I have a</p></td>
            </tr>
            <tr>
                <td><p>4</p></td>
                <td><p>We are in the</p></td>
                <td><p>We are in the</p></td>
                <td><p>We are in the</p></td>
            </tr>
            <tr>
                <td><p>5</p></td>
                <td><p>It is to me that</p></td>
                <td><p>I I I I I</p></td>
                <td><p>Look at me, I</p></td>
            </tr>
            <tr>
                <td><p>6</p></td>
                <td><p>The, and the, and</p></td>
                <td><p>I I I I I I</p></td>
                <td><p></p></td>
            </tr>
            <tr>
                <td><p>7</p></td>
                <td><p>The, the, the, the</p></td>
                <td><p>I I I I I I I</p></td>
                <td><p></p></td>
            </tr>
            <tr>
                <td><p>8</p></td>
                <td><p>I, I, I, I</p></td>
                <td><p>I I I I I I I I</p></td>
                <td><p></p></td>
            </tr>
            <tr>
                <td><p>Greedy</p></td>
                <td><p>The two in the two in the two</p></td>
                <td><p>The two are the two that are the</p></td>
                <td><p>The two are the two that have the</p></td>
            </tr>
        </table>

        <br>

        <p>Interestingly, we find that the maximum likelihood completions appear coherent for shorter lengths while they degenerate for longer lengths. This indicates that highest likelihood decoding may have problems at longer sequence lengths, similar to how greedy decoding can lead to degeneration in other settings (Holtzman et al, 2019). </p>

        <br>

        <p>Our algorithm significantly speeds up finding the highest likelihood sequence. Specifically, for Pythia-70m length 8, the brute force algorithm would take 8344900976819085 forward passes while our algorithm only took 4792 forward passes. You can find more such logs in this <a href="https://github.com/kothasuhas/highest_likelihood/tree/main/logs">folder</a>.</p>

        <h3>Future Work</h3>

        <p>To me, the most exciting extension of this work is testing more difficult tasks that involve multiple steps or reasoning. One task I am particularly excited about is arithmetic, where one sees if the highest likelihood decoding does better than the greedy generation for addition problems. There are also several engineering considerations to make highest likelihood decoding faster such as cleverly managing the KV cache during search. Maybe I'll get around to these on a later date, maybe you can do it for me :P
        </p>

        <br>
 
        <p>Thank you for reading, and feel free to reach out with any questions or thoughts!</p>

        <script type="text/javascript" src="../js/post.js"></script>
    </div>
</body>

</html>


<!-- publish link: http://www.andrew.cmu.edu/server/publish.html -->